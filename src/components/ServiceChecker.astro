---
import fl01Zips from '../data/fl01-zips.json';
---

<div class="checker" id="service-checker">
  <div class="checker__header">
    <h2>Check Your Coverage</h2>
    <p>Enter your ZIP code to verify we service your area.</p>
  </div>
  <div class="checker__input-wrap">
    <input type="text" id="zip-input" placeholder="Enter ZIP" maxlength="5" inputmode="numeric" pattern="[0-9]*" autocomplete="postal-code" aria-label="ZIP code"/>
    <button id="zip-check-btn" class="btn btn--primary">Check Coverage</button>
  </div>
  <div class="checker__result" id="result-covered" hidden>
    <div class="checker__badge checker__badge--yes">âœ“ We service your area!</div>
    <p id="result-city-name"></p>
    <div class="checker__actions">
      <a href="tel:+18504039797" class="btn btn--phone btn--lg">ðŸ“ž Call Now: (850) 403-9797</a>
      <a href="/service/" class="btn btn--secondary">ðŸ“‹ Request Service</a>
      <a href="#" class="btn btn--outline" id="result-details-link">â†’ See local details</a>
    </div>
  </div>
  <div class="checker__result" id="result-not-covered" hidden>
    <div class="checker__badge checker__badge--expand">We're expanding to your area</div>
    <p>Leave your email for launch notification, or call <a href="tel:+18504039797">(850) 403-9797</a> â€” we may still be able to help.</p>
    <div class="checker__email-capture">
      <input type="email" id="notify-email" placeholder="your@email.com" aria-label="Email"/>
      <button class="btn btn--primary" id="notify-btn">Notify Me</button>
    </div>
  </div>
  <div class="checker__result" id="result-invalid" hidden>
    <p class="checker__error">Please enter a valid 5-digit ZIP code.</p>
  </div>
</div>

<script define:vars={{ zips: fl01Zips }}>
  const input=document.getElementById('zip-input'),btn=document.getElementById('zip-check-btn');
  const rc=document.getElementById('result-covered'),rn=document.getElementById('result-not-covered'),ri=document.getElementById('result-invalid');
  const cn=document.getElementById('result-city-name'),dl=document.getElementById('result-details-link');
  function hide(){rc.hidden=rn.hidden=ri.hidden=true}
  function check(){
    const z=input.value.trim();hide();
    if(!/^\d{5}$/.test(z)){ri.hidden=false;return}
    const m=zips.find(x=>x.zip===z);
    if(m){
      cn.textContent=`Coverage confirmed for ${m.city}, FL ${z}`;
      dl.href=`/florida/${m.city.toLowerCase().replace(/\s+/g,'-').replace(/'/g,'')}/hvac/ac-repair/${z}/`;
      rc.hidden=false;
      if(window.plausible)plausible('zip_valid',{props:{zip:z,city:m.city}});
    }else{
      rn.hidden=false;
      if(window.plausible)plausible('zip_not_covered',{props:{zip:z}});
    }
  }
  btn.addEventListener('click',check);
  input.addEventListener('keydown',e=>{if(e.key==='Enter')check()});
  input.addEventListener('input',()=>{input.value=input.value.replace(/\D/g,'')});
</script>

<style>
  .checker{background:var(--white);border-radius:var(--radius-lg);padding:var(--space-2xl);box-shadow:var(--shadow-lg);max-width:600px}
  .checker__header{margin-bottom:var(--space-lg)}
  .checker__header p{color:var(--text-secondary)}
  .checker__input-wrap{display:flex;gap:var(--space-sm);margin-bottom:var(--space-lg)}
  .checker__input-wrap input{flex:1;padding:var(--space-md);border:2px solid var(--slate-200);border-radius:var(--radius-sm);font-size:1.125rem;text-align:center;font-family:var(--font-body);letter-spacing:0.1em}
  .checker__input-wrap input:focus{outline:none;border-color:var(--orange-500);box-shadow:0 0 0 3px rgba(249,115,22,0.15)}
  .checker__result{margin-top:var(--space-lg)}
  .checker__badge{display:inline-block;padding:var(--space-xs) var(--space-md);border-radius:999px;font-weight:700;font-size:0.95rem;margin-bottom:var(--space-md)}
  .checker__badge--yes{background:#DCFCE7;color:var(--green-600)}
  .checker__badge--expand{background:#FEF3C7;color:#92400E}
  .checker__actions{display:flex;flex-wrap:wrap;gap:var(--space-sm);margin-top:var(--space-md)}
  .checker__email-capture{display:flex;gap:var(--space-sm);margin:var(--space-md) 0}
  .checker__email-capture input{flex:1;padding:var(--space-sm) var(--space-md);border:2px solid var(--slate-200);border-radius:var(--radius-sm);font-size:1rem;font-family:var(--font-body)}
  .checker__error{color:var(--red-500);font-weight:600}
  @media(max-width:768px){.checker{padding:var(--space-lg)}.checker__input-wrap,.checker__actions,.checker__email-capture{flex-direction:column}.checker__actions .btn{width:100%;justify-content:center}}
</style>



/**
 * hero-chrome.js â€” Mouse-tracked reflections + page-wide glint sweep
 * 
 * WHAT IT DOES:
 *   1. Tracks mouse position and maps it to reflection coordinates
 *      on all .bar elements within the #brow container
 *   2. Runs a page-wide glint beam that sweeps across ALL elements
 *      with .bar or .chrome-glint class (including nav CTA)
 *   3. Starts idle drift animation after 3s of no mouse movement
 *
 * DEPENDS ON:
 *   - CSS custom properties: --rx, --ry, --rx2, --ry2, --sx, --sy,
 *     --ref-opacity, --beam-offset-x, --beam-offset-y, --beam-pos
 *   - DOM: #brow container, .bar elements, .chrome-glint elements
 */

(function() {
  'use strict';

  const row = document.getElementById('brow');
  if (!row) return; // No hero on this page

  const bars = document.querySelectorAll('.bar');
  if (!bars.length) return;

  let ticking = false;
  let mx = window.innerWidth * 0.38;
  let my = window.innerHeight * 0.3;

  // ---- Mouse reflection tracking ----
  function update() {
    const rowRect = row.getBoundingClientRect();
    const globalX = (mx - rowRect.left) / rowRect.width;
    const globalY = (my - rowRect.top) / rowRect.height;

    bars.forEach(function(b) {
      const r = b.getBoundingClientRect();
      const bL = (r.left - rowRect.left) / rowRect.width;
      const bR = (r.right - rowRect.left) / rowRect.width;
      const bT = (r.top - rowRect.top) / rowRect.height;
      const bB = (r.bottom - rowRect.top) / rowRect.height;
      const lx = ((globalX - bL) / (bR - bL)) * 100;
      const ly = ((globalY - bT) / (bB - bT)) * 100;

      b.style.setProperty('--rx', lx + '%');
      b.style.setProperty('--ry', ly + '%');
      b.style.setProperty('--rx2', (100 - lx * 0.4) + '%');
      b.style.setProperty('--ry2', (100 - ly * 0.3) + '%');
      b.style.setProperty('--sx', (lx * 0.9 + 5) + '%');
      b.style.setProperty('--sy', (ly * 0.85) + '%');

      const d = Math.abs(lx - 50) / 50;
      b.style.setProperty('--ref-opacity', Math.max(0.2, 1 - d * 0.5).toFixed(2));
    });
    ticking = false;
  }

  document.addEventListener('mousemove', function(e) {
    mx = e.clientX;
    my = e.clientY;
    if (!ticking) { requestAnimationFrame(update); ticking = true; }
  });

  document.addEventListener('touchmove', function(e) {
    if (e.touches.length) {
      mx = e.touches[0].clientX;
      my = e.touches[0].clientY;
      if (!ticking) { requestAnimationFrame(update); ticking = true; }
    }
  }, { passive: true });


  // ---- Page-wide glint sweep ----
  var SWEEP = 7000;  // ms to cross viewport
  var PAUSE = 6000;  // ms between sweeps
  var OVER  = 300;   // px overshoot past edges
  var sweepStart = null;
  var pausing = false;
  var pauseStart = null;

  function glint(ts) {
    if (pausing) {
      if (!pauseStart) pauseStart = ts;
      if (ts - pauseStart >= PAUSE) {
        pausing = false;
        pauseStart = null;
        sweepStart = null;
      }
      requestAnimationFrame(glint);
      return;
    }

    if (!sweepStart) sweepStart = ts;
    var raw = Math.min((ts - sweepStart) / SWEEP, 1);

    // Quadratic ease-in-out
    var t = raw < 0.5
      ? 2 * raw * raw
      : 1 - Math.pow(-2 * raw + 2, 2) / 2;

    var total = window.innerWidth + OVER * 2;
    var px = -OVER + t * total;

    // Update ALL chrome elements (bars + nav CTA + any future chrome elements)
    document.querySelectorAll('.bar, .chrome-glint').forEach(function(el) {
      var r = el.getBoundingClientRect();
      el.style.setProperty('--beam-offset-x', r.left.toFixed(0));
      el.style.setProperty('--beam-offset-y', r.top.toFixed(0));
      el.style.setProperty('--beam-pos', px.toFixed(0));
    });

    if (raw >= 1) pausing = true;
    requestAnimationFrame(glint);
  }

  requestAnimationFrame(glint);


  // ---- Idle drift ----
  var idleTimer;
  var angle = 0;
  var isIdle = false;
  var rowCache = row.getBoundingClientRect();

  window.addEventListener('resize', function() {
    rowCache = row.getBoundingClientRect();
  });

  function drift() {
    if (!isIdle) return;
    angle += 0.004;
    mx = rowCache.left + rowCache.width * (0.5 + Math.sin(angle) * 0.65);
    my = rowCache.top + rowCache.height * (0.4 + Math.cos(angle * 0.4) * 0.2);
    if (!ticking) { requestAnimationFrame(update); ticking = true; }
    requestAnimationFrame(drift);
  }

  function resetIdle() {
    isIdle = false;
    clearTimeout(idleTimer);
    rowCache = row.getBoundingClientRect();
    idleTimer = setTimeout(function() {
      isIdle = true;
      drift();
    }, 3000);
  }

  document.addEventListener('mousemove', resetIdle);
  idleTimer = setTimeout(function() { isIdle = true; drift(); }, 3000);

  // Initial render
  update();
})();